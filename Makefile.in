#
# Make file to install/uninstall AsciiDoc
#

INSTALL = @INSTALL@
INSTALL_PROG = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

SED = @SED@
LN_S = @LN_S@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
datadir = @datadir@
sysconfdir = @sysconfdir@
datarootdir = @datarootdir@
mandir=@mandir@
srcdir = @srcdir@

VPATH = @srcdir@

ASCIIDOCCONF = $(sysconfdir)/asciidoc

prog = asciidoc.py a2x
progdir = $(bindir)

vimdir = @sysconfdir@/vim

manp = $(wildcard doc/*.1)
manpdir = $(mandir)/man1

conf = $(wildcard *.conf)
confdir = $(ASCIIDOCCONF)

filters = $(wildcard filters/*.py) $(wildcard filters/*.conf)
filtersdir = $(ASCIIDOCCONF)/filters

docbook = $(wildcard docbook-xsl/*.xsl)
docbookdir = $(ASCIIDOCCONF)/docbook-xsl

dblatex = $(wildcard dblatex/*.xsl) $(wildcard dblatex/*.sty)
dblatexdir = $(ASCIIDOCCONF)/dblatex

css = $(wildcard stylesheets/*.css)
cssdir = $(ASCIIDOCCONF)/stylesheets

js = $(wildcard javascripts/*.js)
jsdir = $(ASCIIDOCCONF)/javascripts

callouts = $(wildcard images/icons/callouts/*)
calloutsdir = $(ASCIIDOCCONF)/images/icons/callouts

icons = $(wildcard images/icons/*.png) images/icons/README
iconsdir = $(ASCIIDOCCONF)/images/icons

doc = $(wildcard README*) $(wildcard BUGS*) $(wildcard INSTALL*)
docdir = $(datadir)/doc/asciidoc

DATATARGETS = manp conf filters docbook dblatex css js callouts icons
PROGTARGETS = prog
TARGETS = $(DATATARGETS) $(PROGTARGETS) doc

INSTDIRS = $(TARGETS:%=%dir)

.PHONY: $(TARGETS)

all: build

# create directories used during the install
$(INSTDIRS):
	$(INSTALL) -d $(DESTDIR)/$($@)

$(PROGTARGETS): % : %dir
	$(INSTALL_PROG) $($@) $(DESTDIR)/$($<)/

$(DATATARGETS): % : %dir
	$(INSTALL_DATA) $($@) $(DESTDIR)/$($<)/

docs:
	$(INSTALL_DATA) $(doc) $(DESTDIR)/$(docdir)
	$(INSTALL) -d $(DESTDIR)/$(docdir)/stylesheets
	$(INSTALL_DATA) $(css) $(DESTDIR)/$(docdir)/stylesheets
	$(INSTALL) -d $(DESTDIR)/$(docdir)/javascripts
	$(INSTALL_DATA) $(js) $(DESTDIR)/$(docdir)/javascripts
	$(INSTALL) -d $(DESTDIR)/$(docdir)/images
	( cd images && \
		cp -R * $(DESTDIR)/$(docdir)/images )
	$(INSTALL) -d $(DESTDIR)/$(docdir)/doc
	( cd doc && \
		cp -R * $(DESTDIR)/$(docdir)/doc )
	$(INSTALL) -d $(DESTDIR)/$(docdir)/examples/website
	( cd examples/website && \
		cp -R * $(DESTDIR)/$(docdir)/examples/website )

linkpy:
	(cd $(DESTDIR)/$(progdir); $(LN_S) asciidoc.py asciidoc)

fixconfpath:
	@for f in $(prog); do \
		echo "Fixing CONF_DIR in $$f"; \
		$(SED) "s#^CONF_DIR = '.*'#CONF_DIR = '$(ASCIIDOCCONF)'#; s#^CONF_DIR=.*#CONF_DIR=$(ASCIIDOCCONF)#" $$f > $$f.out; \
		mv $$f.out $$f; \
	done

install-vim:
	test -d $(DESTDIR)/$(vimdir) && \
		$(INSTALL) -d $(DESTDIR)/$(vimdir)/syntax
	test -d $(DESTDIR)/$(vimdir) && \
		$(INSTALL_DATA) vim/syntax/asciidoc.vim $(DESTDIR)/$(vimdir)/syntax/
	test -d $(DESTDIR)/$(vimdir) && \
		$(INSTALL) -d $(DESTDIR)/$(vimdir)/ftdetect
	test -d $(DESTDIR)/$(vimdir) && \
		$(INSTALL_DATA) vim/ftdetect/asciidoc_filetype.vim \
		$(DESTDIR)/$(vimdir)/ftdetect/


build: fixconfpath

install: $(PROGTARGETS) $(DATATARGETS) linkpy install-vim

uninstall:
	rm -f $(DESTDIR)/$(progdir)/asciidoc
	rm -f $(DESTDIR)/$(progdir)/asciidoc.py
	rm -f $(DESTDIR)/$(progdir)/a2x
	rm -f $(DESTDIR)/$(mandir)/asciidoc.1
	rm -f $(DESTDIR)/$(mandir)/a2x.1
	rm -rf $(DESTDIR)/$(confdir)
	rm -f $(DESTDIR)/$(vimdir)/syntax/asciidoc.vim
	rm -f $(DESTDIR)/$(vimdir)/ftdetect/asciidoc_filetype.vim
	rm -rf $(DESTDIR)/$(docdir)

test:
	@echo "Nothing to see here...Move along."
